<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.A.E.A. World Generation Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #16213e;
            padding: 1rem;
            border-bottom: 2px solid #0f4c75;
            text-align: center;
        }

        .header h1 {
            color: #e43f5a;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #aaa;
            font-size: 0.9rem;
        }

        .main-container {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            min-height: 0;
        }

        .controls-panel {
            width: 300px;
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
            border: 1px solid #0f4c75;
        }

        .visualization-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        .view-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            background: #0f4c75;
            color: #eee;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: #1e6091;
        }

        .tab-button.active {
            background: #e43f5a;
            color: white;
        }

        .view-content {
            flex: 1;
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #0f4c75;
            position: relative;
            min-height: 0;
        }

        .view-panel {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .view-panel.active {
            display: flex;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #0a0a0a;
            border-radius: 4px;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group h3 {
            color: #e43f5a;
            margin-bottom: 0.8rem;
            font-size: 1rem;
        }

        .slider-control {
            margin-bottom: 1rem;
        }

        .slider-control label {
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.85rem;
            color: #ccc;
        }

        .slider-control input[type="range"] {
            width: 100%;
            height: 4px;
            background: #0f4c75;
            outline: none;
            border-radius: 2px;
            appearance: none;
        }

        .slider-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #e43f5a;
            cursor: pointer;
            border-radius: 50%;
        }

        .slider-value {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 0.2rem;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .btn {
            background: #e43f5a;
            color: white;
            border: none;
            padding: 0.8rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #d73c56;
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #0f4c75;
        }

        .btn.secondary:hover {
            background: #1e6091;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #aaa;
        }

        .loading.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: #0f4c75;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e43f5a;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 0.3rem;
        }

        .detail-panel {
            max-height: 300px;
            overflow-y: auto;
            background: #0a0a0a;
            border-radius: 4px;
            padding: 1rem;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .detail-panel h4 {
            color: #e43f5a;
            margin-bottom: 0.5rem;
        }

        .detail-panel .property {
            margin-bottom: 0.3rem;
        }

        .detail-panel .property-name {
            color: #aaa;
            display: inline-block;
            width: 120px;
        }

        .detail-panel .property-value {
            color: #eee;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .controls-panel {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>G.A.E.A. World Generation Visualizer</h1>
        <p>Explore the sophisticated anti-equilibrium world generation system</p>
    </div>

    <div class="main-container">
        <div class="controls-panel">
            <div class="control-group">
                <h3>World Configuration</h3>

                <div class="slider-control">
                    <label>Random Seed</label>
                    <input type="number" id="seed" value="42" min="0" max="10000">
                    <button class="btn secondary" onclick="randomizeSeed()">Randomize</button>
                </div>

                <div class="slider-control">
                    <label>Place Density</label>
                    <input type="range" id="placeDensity" min="0.01" max="0.1" step="0.01" value="0.05">
                    <div class="slider-value" id="placeDensityValue">0.05</div>
                </div>

                <div class="slider-control">
                    <label>G.A.E.A. Intensity</label>
                    <input type="range" id="gaeaIntensity" min="0.0" max="1.0" step="0.1" value="0.7">
                    <div class="slider-value" id="gaeaIntensityValue">0.7</div>
                </div>

                <div class="slider-control">
                    <label>Fungal Spread</label>
                    <input type="range" id="fungalSpread" min="0.0" max="1.0" step="0.1" value="0.6">
                    <div class="slider-value" id="fungalSpreadValue">0.6</div>
                </div>

                <div class="slider-control">
                    <label>Worshipper Density</label>
                    <input type="range" id="worshipperDensity" min="0.0" max="1.0" step="0.1" value="0.5">
                    <div class="slider-value" id="worshipperDensityValue">0.5</div>
                </div>
            </div>

            <div class="control-group">
                <h3>Actions</h3>
                <div class="button-group">
                    <button class="btn" onclick="generateNewWorld()">Generate New World</button>
                    <button class="btn secondary" onclick="exportWorldData()">Export World Data</button>
                    <button class="btn secondary" onclick="exportGameFormat()">Export Game Format</button>
                    <button class="btn secondary" onclick="exportMapImage()">Export Map Image</button>
                </div>
            </div>
        </div>

        <div class="visualization-area">
            <div class="view-tabs">
                <button class="tab-button active" onclick="switchView('spatial')">Spatial View</button>
                <button class="tab-button" onclick="switchView('network')">Network View</button>
                <button class="tab-button" onclick="switchView('analysis')">Analysis View</button>
                <button class="tab-button" onclick="switchView('detail')">Detail View</button>
            </div>

            <div class="view-content">
                <div class="loading" id="loading">
                    <div>Generating world...</div>
                </div>

                <div class="view-panel active" id="spatial-view">
                    <div class="canvas-container">
                        <canvas id="spatial-canvas"></canvas>
                    </div>
                </div>

                <div class="view-panel" id="network-view">
                    <div class="canvas-container">
                        <canvas id="network-canvas"></canvas>
                    </div>
                </div>

                <div class="view-panel" id="analysis-view">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalPlaces">0</div>
                            <div class="stat-label">Total Places</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalExits">0</div>
                            <div class="stat-label">Total Exits</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="infectionZones">0</div>
                            <div class="stat-label">Infection Zones</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="worshipperTerritories">0</div>
                            <div class="stat-label">Worshipper Territories</div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="analysis-canvas"></canvas>
                    </div>
                </div>

                <div class="view-panel" id="detail-view">
                    <div class="detail-panel" id="detail-content">
                        <h4>Select a place to view details</h4>
                        <p>Click on a place in the Spatial View to see detailed information about its G.A.E.A. management profile, ecology, weather, and connections.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

                        <!-- Load CommonJS modules as regular scripts -->
    <script>
        // Create a simple CommonJS system
        window.moduleCache = {};

        // Simple require function
        window.require = function(moduleName) {
            if (moduleName === "./types") {
                return window.moduleCache.worldgenTypes;
            }
            if (moduleName === "../types/world/space") {
                return window.moduleCache.spaceTypes;
            }
            if (moduleName === "../types/index") {
                return window.moduleCache.typesIndex;
            }
            return {};
        };

        // Load types index first
        window.exports = {};
        window.module = { exports: window.exports };
    </script>
    <script src="./dist/types/index.js"></script>
    <script>
        // Cache the types index module
        window.moduleCache.typesIndex = window.exports;

        // Load worldgen types
        window.exports = {};
        window.module = { exports: window.exports };
    </script>
    <script src="./dist/worldgen/types.js"></script>
    <script>
        // Cache the worldgen types module
        window.moduleCache.worldgenTypes = window.exports;

        // Load space types
        window.exports = {};
        window.module = { exports: window.exports };
    </script>
    <script src="./dist/types/world/space.js"></script>
    <script>
        // Cache the space types module
        window.moduleCache.spaceTypes = window.exports;

        // Load worldgen index
        window.exports = {};
        window.module = { exports: window.exports };
    </script>
    <script src="./dist/worldgen/index.js"></script>
    <script>
        // Cache the worldgen index module
        window.moduleCache.worldgenIndex = window.exports;
    </script>

    <script>
        // Extract the exports from the different modules
        const { generateWorld, DEFAULT_WORLD_CONFIG } = window.moduleCache.worldgenIndex;
        const EcosystemName = window.moduleCache.worldgenTypes.EcosystemName;
        const Direction = window.moduleCache.spaceTypes.Direction;

        // Global variables
        let currentWorld = null;
        let selectedPlace = null;
        let currentView = 'spatial';

        // Canvas contexts
        let spatialCtx = null;
        let networkCtx = null;
        let analysisCtx = null;

        // Ecosystem colors (using the correct URNs from the system)
        const ecosystemColors = {
            'flux:eco:mountain:alpine': '#8B4513',
            'flux:eco:mountain:forest': '#228B22',
            'flux:eco:forest:temperate': '#32CD32',
            'flux:eco:grassland:temperate': '#9ACD32',
            'flux:eco:grassland:arid': '#F0E68C'
        };

        // Initialize
        window.addEventListener('load', initializeApp);

        function initializeApp() {
            setupCanvases();
            setupControls();
            generateNewWorld();
        }

        function setupCanvases() {
            const spatialCanvas = document.getElementById('spatial-canvas');
            const networkCanvas = document.getElementById('network-canvas');
            const analysisCanvas = document.getElementById('analysis-canvas');

            spatialCtx = spatialCanvas.getContext('2d');
            networkCtx = networkCanvas.getContext('2d');
            analysisCtx = analysisCanvas.getContext('2d');

            // Set up canvas sizing
            function resizeCanvas(canvas) {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * window.devicePixelRatio;
                canvas.height = rect.height * window.devicePixelRatio;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                const ctx = canvas.getContext('2d');
                ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            }

            resizeCanvas(spatialCanvas);
            resizeCanvas(networkCanvas);
            resizeCanvas(analysisCanvas);

            // Handle canvas clicks
            spatialCanvas.addEventListener('click', handleSpatialClick);
            networkCanvas.addEventListener('click', handleNetworkClick);

            // Handle window resize
            window.addEventListener('resize', () => {
                resizeCanvas(spatialCanvas);
                resizeCanvas(networkCanvas);
                resizeCanvas(analysisCanvas);
                renderCurrentView();
            });
        }

        function setupControls() {
            const sliders = ['placeDensity', 'gaeaIntensity', 'fungalSpread', 'worshipperDensity'];

            sliders.forEach(id => {
                const slider = document.getElementById(id);
                const valueDisplay = document.getElementById(id + 'Value');

                slider.addEventListener('input', (e) => {
                    valueDisplay.textContent = e.target.value;
                });
            });
        }

        function generateNewWorld() {
            setLoading(true);

            // Get configuration from controls
            const config = {
                ...DEFAULT_WORLD_CONFIG,
                place_density: parseFloat(document.getElementById('placeDensity').value),
                gaea_intensity: parseFloat(document.getElementById('gaeaIntensity').value),
                fungal_spread_factor: parseFloat(document.getElementById('fungalSpread').value),
                worshipper_density: parseFloat(document.getElementById('worshipperDensity').value),
                random_seed: parseInt(document.getElementById('seed').value)
            };

            // Generate world asynchronously
            setTimeout(() => {
                try {
                    currentWorld = generateWorld(config);
                    selectedPlace = null;
                    updateAnalysisStats();
                    renderCurrentView();
                    setLoading(false);
                } catch (error) {
                    console.error('Error generating world:', error);
                    setLoading(false);
                }
            }, 100);
        }

        function setLoading(isLoading) {
            const loading = document.getElementById('loading');
            loading.classList.toggle('active', isLoading);
        }

        function updateAnalysisStats() {
            if (!currentWorld) return;

            const totalExits = currentWorld.places.reduce((sum, place) =>
                sum + Object.keys(place.exits).length, 0);

            document.getElementById('totalPlaces').textContent = currentWorld.places.length;
            document.getElementById('totalExits').textContent = totalExits;
            document.getElementById('infectionZones').textContent = currentWorld.infection_zones.length;
            document.getElementById('worshipperTerritories').textContent = currentWorld.worshipper_territories.length;
        }

        function renderCurrentView() {
            if (!currentWorld) return;

            switch (currentView) {
                case 'spatial':
                    renderSpatialView();
                    break;
                case 'network':
                    renderNetworkView();
                    break;
                case 'analysis':
                    renderAnalysisView();
                    break;
            }
        }

        function renderSpatialView() {
            const canvas = document.getElementById('spatial-canvas');
            const ctx = spatialCtx;
            const rect = canvas.getBoundingClientRect();

            ctx.clearRect(0, 0, rect.width, rect.height);

            if (!currentWorld) return;

            // Calculate world bounds
            const worldRadius = currentWorld.config.topology.ecosystem_slices.outer_radius;
            const centerX = currentWorld.config.topology.central_plateau.center[0];
            const centerY = currentWorld.config.topology.central_plateau.center[1];

            // Scale and offset for canvas
            const scale = Math.min(rect.width, rect.height) / (worldRadius * 2.2);
            const offsetX = rect.width / 2 - centerX * scale;
            const offsetY = rect.height / 2 - centerY * scale;

            // Draw topology zones
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;

            // Central plateau
            ctx.beginPath();
            ctx.arc(centerX * scale + offsetX, centerY * scale + offsetY,
                   currentWorld.config.topology.central_plateau.radius * scale, 0, Math.PI * 2);
            ctx.stroke();

            // Mountain ring
            ctx.beginPath();
            ctx.arc(centerX * scale + offsetX, centerY * scale + offsetY,
                   currentWorld.config.topology.mountain_ring.outer_radius * scale, 0, Math.PI * 2);
            ctx.stroke();

            // Ecosystem slices
            ctx.beginPath();
            ctx.arc(centerX * scale + offsetX, centerY * scale + offsetY,
                   currentWorld.config.topology.ecosystem_slices.outer_radius * scale, 0, Math.PI * 2);
            ctx.stroke();

            // Draw places
            currentWorld.places.forEach(place => {
                const distance = place.distance_from_center * worldRadius;
                const angle = place.ecosystem_slice_id !== undefined
                    ? (place.ecosystem_slice_id / currentWorld.config.topology.ecosystem_slices.slice_count) * 2 * Math.PI
                    : Math.random() * 2 * Math.PI;

                const x = centerX + distance * Math.cos(angle);
                const y = centerY + distance * Math.sin(angle);

                const canvasX = x * scale + offsetX;
                const canvasY = y * scale + offsetY;

                // Place color based on ecosystem
                const color = ecosystemColors[place.ecology.ecosystem] || '#666';
                ctx.fillStyle = color;

                // Highlight selected place
                if (selectedPlace && selectedPlace.id === place.id) {
                    ctx.fillStyle = '#ffff00';
                }

                ctx.beginPath();
                ctx.arc(canvasX, canvasY, 3, 0, Math.PI * 2);
                ctx.fill();

                // G.A.E.A. intensity ring
                ctx.strokeStyle = `rgba(255, 0, 0, ${place.gaea_management.management_priority})`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(canvasX, canvasY, 5, 0, Math.PI * 2);
                ctx.stroke();
            });
        }

        function renderNetworkView() {
            const canvas = document.getElementById('network-canvas');
            const ctx = networkCtx;
            const rect = canvas.getBoundingClientRect();

            ctx.clearRect(0, 0, rect.width, rect.height);

            if (!currentWorld) return;

            // Simple force-directed layout simulation
            const places = currentWorld.places.map(place => ({
                ...place,
                x: Math.random() * rect.width,
                y: Math.random() * rect.height,
                vx: 0,
                vy: 0
            }));

            // Draw connections
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;

            places.forEach(place => {
                Object.values(place.exits).forEach(exit => {
                    const targetPlace = places.find(p => p.id === exit.to);
                    if (targetPlace) {
                        ctx.beginPath();
                        ctx.moveTo(place.x, place.y);
                        ctx.lineTo(targetPlace.x, targetPlace.y);
                        ctx.stroke();
                    }
                });
            });

            // Draw places
            places.forEach(place => {
                const color = ecosystemColors[place.ecology.ecosystem] || '#666';
                ctx.fillStyle = color;

                if (selectedPlace && selectedPlace.id === place.id) {
                    ctx.fillStyle = '#ffff00';
                }

                ctx.beginPath();
                ctx.arc(place.x, place.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function renderAnalysisView() {
            const canvas = document.getElementById('analysis-canvas');
            const ctx = analysisCtx;
            const rect = canvas.getBoundingClientRect();

            ctx.clearRect(0, 0, rect.width, rect.height);

            if (!currentWorld) return;

            // Draw ecosystem distribution pie chart
            const ecosystemCounts = {};
            currentWorld.places.forEach(place => {
                const ecosystem = place.ecology.ecosystem;
                ecosystemCounts[ecosystem] = (ecosystemCounts[ecosystem] || 0) + 1;
            });

            const total = currentWorld.places.length;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const radius = Math.min(rect.width, rect.height) / 4;

            let currentAngle = 0;

            Object.entries(ecosystemCounts).forEach(([ecosystem, count]) => {
                const sliceAngle = (count / total) * 2 * Math.PI;
                const color = ecosystemColors[ecosystem] || '#666';

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();

                currentAngle += sliceAngle;
            });

            // Draw labels
            ctx.fillStyle = '#eee';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Ecosystem Distribution', centerX, centerY - radius - 20);
        }

        function handleSpatialClick(event) {
            const canvas = document.getElementById('spatial-canvas');
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;

            // Find clicked place
            const worldRadius = currentWorld.config.topology.ecosystem_slices.outer_radius;
            const centerX = currentWorld.config.topology.central_plateau.center[0];
            const centerY = currentWorld.config.topology.central_plateau.center[1];
            const scale = Math.min(rect.width, rect.height) / (worldRadius * 2.2);
            const offsetX = rect.width / 2 - centerX * scale;
            const offsetY = rect.height / 2 - centerY * scale;

            for (const place of currentWorld.places) {
                const distance = place.distance_from_center * worldRadius;
                const angle = place.ecosystem_slice_id !== undefined
                    ? (place.ecosystem_slice_id / currentWorld.config.topology.ecosystem_slices.slice_count) * 2 * Math.PI
                    : Math.random() * 2 * Math.PI;

                const x = centerX + distance * Math.cos(angle);
                const y = centerY + distance * Math.sin(angle);

                const canvasX = x * scale + offsetX;
                const canvasY = y * scale + offsetY;

                const dx = clickX - canvasX;
                const dy = clickY - canvasY;
                const distanceFromClick = Math.sqrt(dx * dx + dy * dy);

                if (distanceFromClick < 8) {
                    selectedPlace = place;
                    showPlaceDetails(place);
                    renderCurrentView();
                    return;
                }
            }
        }

        function handleNetworkClick(event) {
            // Similar to spatial click but for network view
            // Implementation would be similar to handleSpatialClick
        }

        function showPlaceDetails(place) {
            const detailContent = document.getElementById('detail-content');

            const html = `
                <h4>${place.name}</h4>
                <div class="property">
                    <span class="property-name">Type:</span>
                    <span class="property-value">${place.ecology.ecosystem}</span>
                </div>
                <div class="property">
                    <span class="property-name">Zone:</span>
                    <span class="property-value">${place.topology_zone}</span>
                </div>
                <div class="property">
                    <span class="property-name">Distance:</span>
                    <span class="property-value">${(place.distance_from_center * 100).toFixed(1)}%</span>
                </div>
                <div class="property">
                    <span class="property-name">G.A.E.A. Priority:</span>
                    <span class="property-value">${(place.gaea_management.management_priority * 100).toFixed(1)}%</span>
                </div>
                <div class="property">
                    <span class="property-name">Infection Risk:</span>
                    <span class="property-value">${(place.cordyceps_habitat.infection_risk * 100).toFixed(1)}%</span>
                </div>
                <div class="property">
                    <span class="property-name">Temperature:</span>
                    <span class="property-value">${place.weather.temperature.toFixed(1)}Â°C</span>
                </div>
                <div class="property">
                    <span class="property-name">Humidity:</span>
                    <span class="property-value">${place.weather.humidity.toFixed(1)}%</span>
                </div>
                <div class="property">
                    <span class="property-name">Exits:</span>
                    <span class="property-value">${Object.keys(place.exits).length}</span>
                </div>
                <h4>Connections</h4>
                ${Object.entries(place.exits).map(([direction, exit]) =>
                    `<div class="property">
                        <span class="property-name">${direction}:</span>
                        <span class="property-value">${exit.label}</span>
                    </div>`
                ).join('')}
            `;

            detailContent.innerHTML = html;
        }

        // Global functions
        window.switchView = function(view) {
            currentView = view;

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchView('${view}')"]`).classList.add('active');

            // Update view panels
            document.querySelectorAll('.view-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');

            renderCurrentView();
        };

        window.randomizeSeed = function() {
            document.getElementById('seed').value = Math.floor(Math.random() * 10000);
        };

        window.generateNewWorld = generateNewWorld;

        window.exportWorldData = function() {
            if (!currentWorld) return;

            const dataStr = JSON.stringify(currentWorld, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'world-data.json';
            link.click();
            URL.revokeObjectURL(url);
        };

        window.exportGameFormat = function() {
            if (!currentWorld) return;

            const gamePlaces = currentWorld.places.map(place => ({
                id: place.id,
                name: place.name,
                description: place.description,
                exits: place.exits
            }));

            const dataStr = JSON.stringify(gamePlaces, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'places.json';
            link.click();
            URL.revokeObjectURL(url);
        };

        window.exportMapImage = function() {
            const canvas = document.getElementById('spatial-canvas');
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'world-map.png';
            link.click();
        };
    </script>
</body>
</html>
